<!DOCTYPE html>
<html>
<head>
    <title>Profile Settings</title>
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>
    <style>
        body { background-color: #0d0d1a; color: #e0e0e0; font-family: 'Segoe UI', sans-serif; padding: 40px; }
        .card { background-color: #161625; border: 1px solid #2d2d3d; border-radius: 12px; padding: 30px; max-width: 800px; margin: auto; }
        .profile-preview { width: 120px; height: 120px; border-radius: 50%; object-fit: cover; border: 3px solid #7c3aed; margin-bottom: 15px; }
        input[type="text"] { width: 100%; background: #1e1e30; border: 1px solid #374151; border-radius: 6px; padding: 10px; color: white; margin-bottom: 20px; }
        .btn-save { background-color: #7c3aed; color: white; border: none; padding: 12px 25px; border-radius: 8px; cursor: pointer; font-weight: bold; }
        .hidden { display: none !important; }
        .locked { opacity: 0.5; pointer-events: none; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    </style>
</head>
<body>

<div class="card">
    <div class="header">
        <h1>Profile</h1>
        <button id="loginBtn" class="btn-save" onclick="initAuth()">Login to Edit</button>
        <button id="saveBtn" class="btn-save hidden" onclick="saveToDrive()">Save to Cloud</button>
    </div>

    <div id="editor-ui">
        <label>Profile Image</label><br>
        <img id="imgPreview" src="images/dp.png" class="profile-preview"><br>
        <button id="pickBtn" class="btn-save locked" onclick="openPicker()" style="background:#fff; color:#000; margin-bottom:20px;">Change Image</button>

        <label>Full Name</label>
        <input type="text" id="userName" placeholder="Enter name">

        <label>Headlines</label>
        <div id="headlines-list"></div>
    </div>
    <div id="status" style="color:lawngreen; display:none;">Saved and Synced!</div>
</div>

<script>
    const API_KEY = 'AIzaSyBnziBqqKAO39yg8rtTNxL8c_3xJjQWboc';
    const CLIENT_ID = '892225644868-rrc1htua9bhmpdfpt96uklmddpd3jf8a.apps.googleusercontent.com';
    const CONFIG_FILE_NAME = 'portfolio_config.json';

    let accessToken = null;
    let configFilesId = null;

    // 1. ALWAYS LOAD DATA ON START (No login required)
    window.onload = () => {
        gapi.load('picker');
        
        // Load from Local Storage so it's always visible to everyone
        const savedName = localStorage.getItem('adminName');
        const savedImg = localStorage.getItem('adminProfileImg');
        const savedHeadlines = JSON.parse(localStorage.getItem('adminHeadlines'));

        if (savedName) document.getElementById('userName').value = savedName;
        if (savedImg) document.getElementById('imgPreview').src = savedImg;
        if (savedHeadlines) {
            document.getElementById('headlines-list').innerHTML = "";
            savedHeadlines.forEach(h => addInput(h));
        } else {
            addInput();
        }
    };

    // 2. AUTHENTICATION (Only when you want to edit)
    function initAuth() {
        const tokenClient = google.accounts.oauth2.initTokenClient({
            client_id: CLIENT_ID,
            scope: 'https://www.googleapis.com/auth/drive.file https://www.googleapis.com/auth/drive.readonly',
            callback: (resp) => {
                accessToken = resp.access_token;
                document.getElementById('loginBtn').classList.add('hidden');
                document.getElementById('saveBtn').classList.remove('hidden');
                document.getElementById('pickBtn').classList.remove('locked');
                loadConfigFromDrive(); // Sync with freshest cloud data
            },
        });
        tokenClient.requestAccessToken();
    }

    function addInput(value = "") {
        const input = document.createElement('input');
        input.type = "text";
        input.className = "headline-input";
        input.value = value;
        document.getElementById('headlines-list').appendChild(input);
    }

    function openPicker() {
        const view = new google.picker.View(google.picker.ViewId.DOCS_IMAGES);
        const picker = new google.picker.PickerBuilder()
            .addView(view).setOAuthToken(accessToken).setDeveloperKey(API_KEY)
            .setCallback((data) => {
                if (data.action == google.picker.Action.PICKED) {
                    const url = data.docs[0].thumbnails[0].url.replace('s220', 's1000');
                    document.getElementById('imgPreview').src = url;
                }
            }).build();
        picker.setVisible(true);
    }

    async function saveToDrive() {
        const headlines = Array.from(document.querySelectorAll('.headline-input')).map(i => i.value);
        const configData = {
            name: document.getElementById('userName').value,
            headlines: headlines,
            imgUrl: document.getElementById('imgPreview').src
        };

        // SAVE TO LOCAL STORAGE (For public viewing)
        localStorage.setItem('adminName', configData.name);
        localStorage.setItem('adminProfileImg', configData.imgUrl);
        localStorage.setItem('adminHeadlines', JSON.stringify(configData.headlines));

        // SAVE TO GOOGLE DRIVE (For cloud backup)
        const metadata = { name: CONFIG_FILE_NAME, mimeType: 'application/json' };
        const form = new FormData();
        form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
        form.append('file', new Blob([JSON.stringify(configData)], { type: 'application/json' }));

        const url = configFilesId 
            ? `https://www.googleapis.com/upload/drive/v3/files/${configFilesId}?uploadType=multipart`
            : 'https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart';

        await fetch(url, { method: configFilesId ? 'PATCH' : 'POST', headers: { 'Authorization': 'Bearer ' + accessToken }, body: form });
        
        document.getElementById('status').style.display = 'block';
        setTimeout(() => location.reload(), 1500);
    }

    async function loadConfigFromDrive() {
        const response = await fetch(`https://www.googleapis.com/drive/v3/files?q=name='${CONFIG_FILE_NAME}'`, {
            headers: { 'Authorization': 'Bearer ' + accessToken }
        });
        const data = await response.json();
        if (data.files && data.files.length > 0) configFilesId = data.files[0].id;
    }
</script>
</body>
</html>

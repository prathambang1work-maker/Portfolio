<!DOCTYPE html>
<html>
<head>
    <title>Profile Settings - Google Drive</title>
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>
    <style>
        body { background-color: #0d0d1a; color: #e0e0e0; font-family: 'Segoe UI', sans-serif; margin: 0; padding: 40px; }
        .container { max-width: 900px; margin: 0 auto; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .card { background-color: #161625; border: 1px solid #2d2d3d; border-radius: 12px; padding: 30px; }
        .section-header { display: flex; align-items: center; margin-bottom: 25px; }
        .icon-box { background: #2d2d44; color: #a78bfa; padding: 8px; border-radius: 6px; margin-right: 12px; }
        .grid { display: grid; grid-template-columns: 1fr 1.5fr; gap: 40px; }
        label { display: block; font-size: 0.85rem; color: #9ca3af; margin-bottom: 8px; }
        input[type="text"] { width: 100%; background: #1e1e30; border: 1px solid #374151; border-radius: 6px; padding: 10px; color: white; box-sizing: border-box; outline: none; }
        input[type="text"]:focus { border-color: #7c3aed; }
        .btn-save { background-color: #7c3aed; color: white; border: none; padding: 12px 25px; border-radius: 8px; cursor: pointer; font-weight: bold; transition: 0.2s; }
        .btn-save:hover { background-color: #6d28d9; transform: translateY(-2px); }
        .btn-delete { background-color: #dc2626; color: white; border: none; border-radius: 6px; padding: 0 15px; cursor: pointer; }
        .row { display: flex; gap: 10px; margin-bottom: 12px; }
        .profile-preview { width: 120px; height: 120px; border-radius: 50%; object-fit: cover; border: 3px solid #7c3aed; margin-bottom: 15px; display: block; background: #0d0d1a; }
        .choose-btn { background: #ffffff; color: #000; padding: 10px 18px; border-radius: 20px; font-size: 0.85rem; cursor: pointer; display: inline-flex; align-items: center; gap: 8px; border: none; font-weight: bold; }
        a.back-link { color: #9ca3af; text-decoration: none; font-size: 0.9rem; margin-bottom: 10px; display: block; }
        .status-msg { font-size: 0.8rem; margin-top: 10px; color: #10b981; display: none; }
    </style>
</head>
<body>

<div class="container">
    <a href="portfolio dashboard.html" class="back-link">‚Üê Back to Dashboard</a>
    <div class="header">
        <h1>Profile Settings</h1>
        <button class="btn-save" id="saveBtn" onclick="saveToDrive()">Save to Cloud</button>
    </div>

    <div class="card">
        <div class="section-header">
            <div class="icon-box">üë§</div>
            <h2 style="margin:0; font-size: 1.2rem;">Profile Settings</h2>
        </div>

        <div class="grid">
            <div>
                <label>Profile Image</label>
                <img id="imgPreview" src="images/dp.png" class="profile-preview">
                <button class="choose-btn" onclick="openPicker()">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/1/12/Google_Drive_icon_%282020%29.svg" width="18">
                    Choose a Picture
                </button>
            </div>

            <div>
                <div style="margin-bottom: 25px;">
                    <label>Full Name</label>
                    <input type="text" id="userName" placeholder="Enter your name">
                </div>

                <div>
                    <label>Rotating Headlines (Animated Text)</label>
                    <div id="headlines-list"></div>
                    <button onclick="addInput()" style="background:none; border:1px dashed #444; color:#aaa; width:100%; padding:10px; cursor:pointer; border-radius:6px; margin-top:8px;">+ Add New Headline</button>
                </div>
                <div id="status" class="status-msg">DONE!</div>
            </div>
        </div>
    </div>
</div>

<script>
// YOUR PROVIDED CREDENTIALS
const API_KEY = 'AIzaSyBnziBqqKAO39yg8rtTNxL8c_3xJjQWboc';
const CLIENT_ID = '892225644868-rrc1htua9bhmpdfpt96uklmddpd3jf8a.apps.googleusercontent.com';
const CONFIG_FILE_NAME = 'portfolio_config.json';

let accessToken = null;
let configFilesId = null;
let selectedImgUrl = "";

// 1. FAST LOAD: Show data immediately from LocalStorage
function fastLoad() {
    const savedName = localStorage.getItem('adminName');
    const savedImg = localStorage.getItem('adminProfileImg');
    const savedHeadlines = JSON.parse(localStorage.getItem('adminHeadlines'));

    if (savedName) document.getElementById('userName').value = savedName;
    if (savedImg) document.getElementById('imgPreview').src = savedImg;
    
    const list = document.getElementById('headlines-list');
    list.innerHTML = ""; // Clear default
    if (savedHeadlines && savedHeadlines.length > 0) {
        savedHeadlines.forEach(h => addInput(h));
    } else {
        addInput(); // Fallback empty row
    }
}

// 2. AUTHENTICATION: Triggered by the "Login to Edit" button
function initAuth() {
    const tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID,
        scope: 'https://www.googleapis.com/auth/drive.file https://www.googleapis.com/auth/drive.readonly',
        callback: (resp) => {
            accessToken = resp.access_token;
            
            // Show admin tools, hide login button
            document.getElementById('saveBtn').style.display = 'block';
            document.getElementById('adminLogin').style.display = 'none';
            document.querySelector('.choose-btn').style.opacity = '1';
            document.querySelector('.choose-btn').style.pointerEvents = 'auto';
            
            // Sync with actual cloud data to ensure it's fresh
            loadConfigFromDrive();
        },
    });
    tokenClient.requestAccessToken();
}

// ... (keep addInput, openPicker, and loadConfigFromDrive functions the same)

async function saveToDrive() {
    const saveBtn = document.getElementById('saveBtn');
    saveBtn.innerText = "Syncing...";

    const headlines = Array.from(document.querySelectorAll('.headline-input'))
                           .map(i => i.value).filter(v => v.trim());

    const configData = {
        name: document.getElementById('userName').value,
        headlines: headlines,
        imgUrl: selectedImgUrl || document.getElementById('imgPreview').src
    };

    const metadata = { name: CONFIG_FILE_NAME, mimeType: 'application/json' };
    const fileContent = JSON.stringify(configData);
    const form = new FormData();
    form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
    form.append('file', new Blob([fileContent], { type: 'application/json' }));

    const url = configFilesId 
        ? `https://www.googleapis.com/upload/drive/v3/files/${configFilesId}?uploadType=multipart`
        : 'https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart';

    await fetch(url, {
        method: configFilesId ? 'PATCH' : 'POST',
        headers: { 'Authorization': 'Bearer ' + accessToken },
        body: form
    });

    // CRITICAL: Update LocalStorage after cloud save
    localStorage.setItem('adminName', configData.name);
    localStorage.setItem('adminProfileImg', configData.imgUrl);
    localStorage.setItem('adminHeadlines', JSON.stringify(configData.headlines));

    saveBtn.innerText = "Save to Cloud";
    document.getElementById('status').style.display = 'block';
    setTimeout(() => document.getElementById('status').style.display = 'none', 3000);
}

window.onload = () => {
    gapi.load('picker');
    
    // Initial UI state
    document.getElementById('saveBtn').style.display = 'none';
    document.querySelector('.choose-btn').style.opacity = '0.5';
    document.querySelector('.choose-btn').style.pointerEvents = 'none';

    // Show data instantly
    fastLoad();

    // Add Login button
    const loginBtn = document.createElement('button');
    loginBtn.id = "adminLogin";
    loginBtn.innerText = "Login to Edit";
    loginBtn.className = "btn-save"; 
    loginBtn.style.background = "#444";
    loginBtn.onclick = initAuth;
    document.querySelector('.header').appendChild(loginBtn);
};
</script>
</script>
</body>
</html>




